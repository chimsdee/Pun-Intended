<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pun Intended - Jokes</title>
  <link rel="icon" type="image/png" href="./IMG/main.svg">
  <link rel="stylesheet" href="./CSS/bootstrap.css">
  <link rel="stylesheet" href="./CSS/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body class="jokes-page">
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">
          <i class="fas fa-laugh-wink me-2"></i> Pun Intended
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mx-auto gap-4">
            <li class="nav-item">
              <a class="nav-link" href="main_page.html">
                <i class="fas fa-home me-1"></i> Main
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quotes_page.html">
                <i class="fas fa-quote-left me-1"></i> Quotes
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html" style="color: white;">
                <i class="fas fa-sign-out me-1"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <main class="container text-center mt-5 pt-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-9 col-lg-7">
        <div class="card joke-card shadow-lg mb-3" style="background-color: bisque;">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 class="card-title mb-1">Joke of the Moment</h5>
                <blockquote class="text-muted" id="joke-source" style="font-weight: bold;">Source: Official Joke API
                </blockquote>
              </div>
              <div class="text-end">
                <strong class="text-muted">Generated: <span id="generatedCount">0</span></strong>
              </div>
            </div>

            <div id="jokeArea" class="joke-area">
              <p id="setup" class="lead mb-2 text-wrap" aria-live="polite">Click <strong>Generate</strong> to fetch a
                joke.</p>
              <p id="punchline" class="fs-5 fw-semibold text-wrap"></p>
            </div>

            <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center mt-4">
              <button id="generateBtn" class="btn btn-warning btn-lg shadow-sm">
                <i class="fas fa-bolt me-2"></i><span class="btn-text">Generate</span>
              </button>

              <div class="btn btn-group-lg" role="group" aria-label="reaction buttons">
                <button id="likeBtn" class="btn btn-outline-success" style="border: transparent;" title="Like (L)">
                  <i class="fas fa-thumbs-up me-2"></i><span id="likeCount">0</span>
                </button>
                <button id="dislikeBtn" class="btn btn-outline-danger" style="border: transparent;" title="Dislike (D)">
                  <i class="fas fa-thumbs-down me-2"></i><span id="dislikeCount">0</span>
                </button>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-between align-items-center">
              <small class="text-muted">Shortcuts: <kbd>G</kbd> Generate • <kbd>L</kbd> Like • <kbd>D</kbd>
                Dislike</small>
              <div>
                <button id="historyToggle" class="btn btn-sm btn-outline-secondary"
                  style="border: transparent; font-weight: bold;">View History</button>
              </div>
            </div>
          </div>
        </div>
        <div id="historyPanel" class="card d-none">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">History</h6>
              <div>
                <button id="clearHistory" class="btn btn-sm btn-danger">Clear</button>
              </div>
            </div>
            <ul id="historyList" class="list-group list-group-flush" style="max-height: 260px; overflow:auto;"></ul>
            <div class="mt-3 text-end">
              <small class="text-muted">Stored locally in your browser.</small>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="modal fade" id="confirmClearModal" tabindex="-1" aria-labelledby="confirmClearLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light border-light">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmClearLabel">Confirm Reset</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-start">
            <p>
              You're about to permanently delete all your joke history and reset your like/dislike counts back to zero.
              This action can't be undone.
            </p>
            <p class="mb-0"><strong>Are you sure you want to proceed?</strong></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button id="confirmClearBtn" type="button" class="btn btn-danger">Yes, Reset Everything</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <footer class="footer py-3 bg-dark mt-4">
    <div class="container text-center">
      <small class="text-light">
        &copy; 2025 Pun Intended. Made with <i class="fas fa-heart text-danger"></i> for laughter & inspiration
        <span class="mx-2">|</span>
        <a href="privacy.html" class="text-light text-decoration-none me-2">Privacy Policy</a>
        <a href="terms.html" class="text-light text-decoration-none me-2">Terms of Service</a>
        <a href="contact.html" class="text-light text-decoration-none">Contact</a>
      </small>
    </div>
  </footer>

  <script src="JS/bootstrap.js"></script>
  <script src="JS/script.js"></script>
  <script>
    (() => {
      const API = 'https://official-joke-api.appspot.com/random_joke';
      const generateBtn = document.getElementById('generateBtn');
      const likeBtn = document.getElementById('likeBtn');
      const dislikeBtn = document.getElementById('dislikeBtn');
      const setupEl = document.getElementById('setup');
      const punchlineEl = document.getElementById('punchline');
      const generatedCountEl = document.getElementById('generatedCount');
      const likeCountEl = document.getElementById('likeCount');
      const dislikeCountEl = document.getElementById('dislikeCount');
      const historyToggle = document.getElementById('historyToggle');
      const historyPanel = document.getElementById('historyPanel');
      const historyList = document.getElementById('historyList');
      const clearHistory = document.getElementById('clearHistory');
      const jokeSource = document.getElementById('joke-source');
      const jokeArea = document.getElementById('jokeArea');

      const confirmClearModalEl = document.getElementById('confirmClearModal');
      const confirmClearBtn = document.getElementById('confirmClearBtn');
      const confirmClearModal = confirmClearModalEl ? new bootstrap.Modal(confirmClearModalEl) : null;

      // LocalStorage keys
      const LS_KEYS = {
        stats: 'pi_joke_stats_v1',
        history: 'pi_joke_history_v1'
      };

      let lastJoke = null;
      let isLoading = false;

      /* ---------- STORAGE UTILS ---------- */
      const defaultStats = { generated: 0, likes: 0, dislikes: 0 };

      function loadStats() {
        try {
          const raw = localStorage.getItem(LS_KEYS.stats);
          return raw ? JSON.parse(raw) : defaultStats;
        } catch {
          return defaultStats;
        }
      }

      function saveStats(s) {
        localStorage.setItem(LS_KEYS.stats, JSON.stringify(s));
      }

      function loadHistory() {
        try {
          const raw = localStorage.getItem(LS_KEYS.history);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }

      function saveHistory(h) {
        localStorage.setItem(LS_KEYS.history, JSON.stringify(h));
      }

      /* ---------- UI HELPERS ---------- */
      function refreshCounters() {
        const s = loadStats();
        generatedCountEl.textContent = s.generated;
        likeCountEl.textContent = s.likes;
        dislikeCountEl.textContent = s.dislikes;
      }

      function animateJoke() {
        jokeArea.classList.remove('fade-in');
        void jokeArea.offsetWidth;
        jokeArea.classList.add('fade-in');
      }

      function flashTemp(btn, text, timeout = 900) {
        const prev = btn.innerHTML;
        btn.innerHTML = text;
        setTimeout(() => (btn.innerHTML = prev), timeout);
      }

      function escapeHtml(str = '') {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function showError(msg = "Couldn't fetch a joke. Try again.") {
        setupEl.textContent = msg;
        punchlineEl.textContent = '';
        jokeSource.textContent = 'Source: (offline)';
        animateJoke();
      }

      /* ---------- HISTORY RENDERING ---------- */
      function renderHistory() {
        const items = loadHistory();
        historyList.innerHTML = '';
        if (!items.length) {
          const li = document.createElement('li');
          li.className = 'list-group-item text-muted';
          li.textContent = 'No rated jokes yet. Like or dislike a joke to build history.';
          historyList.appendChild(li);
          return;
        }

        items
          .slice()
          .reverse()
          .forEach((it) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-start';

            const left = document.createElement('div');
            left.style.maxWidth = '78%';
            left.innerHTML = `
          <div class="history-setup">${escapeHtml(it.setup)}</div>
          <div class="history-meta">${escapeHtml(it.punchline)}</div>
          <div class="history-meta small mt-1">
            ${new Date(it.ts).toLocaleString()} • ${it.rating.toUpperCase()}
          </div>`;

            const right = document.createElement('div');
            right.className = 'd-flex flex-column gap-1 align-items-end';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-sm btn-outline-secondary';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = () => {
              navigator.clipboard?.writeText(`${it.setup} — ${it.punchline}`).then(() => {
                flashTemp(copyBtn, 'Copied');
              });
            };

            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = () => removeHistoryItem(it.id, it.ts);

            right.appendChild(copyBtn);
            right.appendChild(removeBtn);

            li.appendChild(left);
            li.appendChild(right);
            historyList.appendChild(li);
          });
      }

      function removeHistoryItem(id, ts) {
        const items = loadHistory();
        const idx = items.findIndex((x) => x.id === id && x.ts === ts);
        if (idx > -1) {
          items.splice(idx, 1);
          saveHistory(items);
          renderHistory();
          flashTemp(clearHistory, 'Removed');
        }
      }

      /* ---------- API FETCH ---------- */
      async function fetchJoke() {
        if (isLoading) return;
        isLoading = true;
        generateBtn.setAttribute('disabled', 'disabled');
        const prevHtml = generateBtn.innerHTML;
        generateBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Loading`;

        try {
          const res = await fetch(API, { cache: 'no-store' });
          if (!res.ok) throw new Error('Bad response');
          const data = await res.json();

          if (lastJoke && data.id && data.id === lastJoke.id) {
            const second = await fetch(API, { cache: 'no-store' }).then((r) => r.json()).catch(() => null);
            if (second && second.id !== data.id) Object.assign(data, second);
          }

          lastJoke = data;
          const setup = data.setup ?? data.joke ?? '';
          const punchline = data.punchline ?? (data.type === 'single' ? data.joke : '') ?? '';

          setupEl.textContent = setup || '—';
          punchlineEl.textContent = punchline || '';
          jokeSource.textContent = 'Source: Official Joke API';
          animateJoke();

          const stats = loadStats();
          stats.generated = (stats.generated || 0) + 1;
          saveStats(stats);
          refreshCounters();
        } catch (err) {
          console.error(err);
          showError();
        } finally {
          isLoading = false;
          generateBtn.removeAttribute('disabled');
          generateBtn.innerHTML = prevHtml;
        }
      }

      /* ---------- RATING ---------- */
      function rateCurrent(rating) {
        if (!lastJoke || (!lastJoke.setup && !lastJoke.punchline)) {
          flashTemp(generateBtn, 'Generate first', 900);
          return;
        }

        const hist = loadHistory();
        const entry = {
          id: lastJoke.id ?? 'local-' + Date.now(),
          setup: lastJoke.setup ?? lastJoke.joke ?? '',
          punchline: lastJoke.punchline ?? (lastJoke.type === 'single' ? lastJoke.joke : '') ?? '',
          rating,
          ts: Date.now()
        };
        hist.push(entry);
        saveHistory(hist);

        const stats = loadStats();
        if (rating === 'like') stats.likes = (stats.likes || 0) + 1;
        else stats.dislikes = (stats.dislikes || 0) + 1;
        saveStats(stats);

        refreshCounters();
        renderHistory();
        flashTemp(rating === 'like' ? likeBtn : dislikeBtn, 'Saved', 700);
      }

      /* ---------- RESET + MODAL ---------- */
      function resetAllData() {
        localStorage.removeItem(LS_KEYS.history);
        localStorage.removeItem(LS_KEYS.stats);
        renderHistory();
        refreshCounters();
        flashTemp(clearHistory, 'Reset done');
      }

      function showResetModal() {
        if (confirmClearModal) confirmClearModal.show();
      }

      if (confirmClearBtn) {
        confirmClearBtn.addEventListener('click', () => {
          if (confirmClearModal) confirmClearModal.hide();
          resetAllData();
        });
      }

      /* ---------- KEYBOARD SHORTCUTS ---------- */
      function onKey(e) {
        if (document.activeElement && ['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
        const key = e.key.toLowerCase();
        if (key === 'g') fetchJoke();
        if (key === 'l') rateCurrent('like');
        if (key === 'd') rateCurrent('dislike');
      }

      /* ---------- HISTORY TOGGLE ---------- */
      function toggleHistory() {
        historyPanel.classList.toggle('d-none');
        if (!historyPanel.classList.contains('d-none')) {
          renderHistory();
          historyToggle.textContent = 'Hide History';
        } else {
          historyToggle.textContent = 'View History';
        }
      }

      /* ---------- INIT ---------- */
      function init() {
        refreshCounters();
        renderHistory();

        generateBtn.addEventListener('click', fetchJoke);
        likeBtn.addEventListener('click', () => rateCurrent('like'));
        dislikeBtn.addEventListener('click', () => rateCurrent('dislike'));
        historyToggle.addEventListener('click', toggleHistory);
        clearHistory.addEventListener('click', showResetModal);
        window.addEventListener('keydown', onKey);
      }

      init();
    })();
  </script>
</body>

</html>